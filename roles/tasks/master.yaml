---
- name: Playbook to run only master nodes.
  hosts: master
  remote_user: root
  
  tasks:

  - name: Check port 6443
    shell: ss -tulnp | grep 6443
    register: port



  - name: Start cluster by kubeadm
    shell: kubeadm init --pod-network-cidr=192.168.0.0/16
    when: port.stdout == ""
    register: init_cluster

  - name: Add a line to a file 
    ansible.builtin.lineinfile:
      path: /etc/environment
      line: KUBECONFIG="/etc/kubernetes/admin.conf"
   
  - name: Export kubeconfig to create resources
    shell: export KUBECONFIG="/etc/kubernetes/admin.conf"
    
  - name: Start cluster by kubeadm
    shell: kubectl create -f https://projectcalico.docs.tigera.io/manifests/tigera-operator.yaml && kubectl create -f https://projectcalico.docs.tigera.io/manifests/custom-resources.yaml
    when: init_cluster is not skipped

  - name: Generate join command
    shell: kubeadm token create --print-join-command > /tmp/kubeadm-join.sh
    register: kubeadm_join

  - name: Fetch join.sh 
    fetch:
      src: /tmp/kubeadm-join.sh
      dest: /tmp/kubeadm-join.sh
  #  debug: var=kubeadm_join.stdout

